---
interface DocEntry {
  slug: string;
  data: {
    title: string;
    section?: string;
    order?: number;
  };
}

interface Props {
  docsBySection: Record<string, DocEntry[]>;
  currentPath: string;
  currentSection?: string;
  currentPage?: string;
}

const { docsBySection, currentPath, currentSection, currentPage } = Astro.props;
---

<!-- Mobile Sidebar - Only visible on small screens -->
<div class="lg:hidden sticky top-16 z-40 bg-white border-b border-slate-200">
  <div class="flex items-center px-4 py-3">
    <!-- Hamburger Button -->
    <button
      id="mobile-menu-button"
      type="button"
      class="flex items-center justify-center w-10 h-10 -ml-2 rounded-md text-slate-600 hover:text-slate-900 hover:bg-slate-100 transition-colors"
      aria-label="Open navigation menu"
      aria-expanded="false"
    >
      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>

    <!-- Breadcrumbs -->
    <div class="flex items-center ml-2 text-sm text-slate-600 overflow-hidden">
      {currentSection && (
        <>
          <span class="truncate text-slate-500">{currentSection}</span>
          <svg class="w-4 h-4 mx-1 flex-shrink-0 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </>
      )}
      {currentPage && (
        <span class="font-medium text-slate-900 truncate">{currentPage}</span>
      )}
    </div>
  </div>
</div>

<!-- Overlay -->
<div
  id="mobile-menu-overlay"
  class="fixed inset-0 z-40 bg-black/50 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden"
></div>

<!-- Sidebar Panel -->
<aside
  id="mobile-sidebar"
  class="fixed top-0 left-0 z-50 h-full w-72 max-w-[85vw] bg-white shadow-xl transform -translate-x-full transition-transform duration-300 ease-out lg:hidden"
>
  <!-- Sidebar Header -->
  <div class="flex items-center justify-between h-16 px-4 border-b border-slate-200 bg-[#6566F1]">
    <span class="font-semibold text-white">Documentation</span>
    <button
      id="mobile-menu-close"
      type="button"
      class="flex items-center justify-center w-10 h-10 -mr-2 rounded-md text-white/80 hover:text-white hover:bg-white/10 transition-colors"
      aria-label="Close navigation menu"
    >
      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>

  <!-- Sidebar Navigation -->
  <nav class="overflow-y-auto h-[calc(100%-4rem)] py-6 px-4">
    <div class="space-y-8">
      {
        Object.entries(docsBySection).map(([section, docs]) => (
          <div>
            <h3 class="mb-3 text-xs font-semibold uppercase tracking-wider text-slate-500">
              {section}
            </h3>
            <ul class="space-y-1 border-l border-slate-200">
              {docs.map((doc) => {
                const href = `/docs/${doc.slug}`;
                const isActive = currentPath === href;
                return (
                  <li>
                    <a
                      href={href}
                      class:list={[
                        'block border-l-2 py-2 pl-4 text-sm transition-colors',
                        isActive
                          ? '-ml-px border-slate-900 text-slate-900 font-medium bg-slate-50'
                          : '-ml-px border-transparent text-slate-600 hover:border-slate-400 hover:text-slate-900',
                      ]}
                    >
                      {doc.data.title}
                    </a>
                  </li>
                );
              })}
            </ul>
          </div>
        ))
      }
    </div>
  </nav>
</aside>

<script>
  function initMobileSidebar() {
    const menuButton = document.getElementById('mobile-menu-button');
    const closeButton = document.getElementById('mobile-menu-close');
    const sidebar = document.getElementById('mobile-sidebar');
    const overlay = document.getElementById('mobile-menu-overlay');

    if (!menuButton || !closeButton || !sidebar || !overlay) return;

    function openMenu() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('opacity-0', 'pointer-events-none');
      overlay.classList.add('opacity-100', 'pointer-events-auto');
      menuButton.setAttribute('aria-expanded', 'true');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      sidebar.classList.add('-translate-x-full');
      sidebar.classList.remove('translate-x-0');
      overlay.classList.add('opacity-0', 'pointer-events-none');
      overlay.classList.remove('opacity-100', 'pointer-events-auto');
      menuButton.setAttribute('aria-expanded', 'false');
      document.body.style.overflow = '';
    }

    menuButton.addEventListener('click', openMenu);
    closeButton.addEventListener('click', closeMenu);
    overlay.addEventListener('click', closeMenu);

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !sidebar.classList.contains('-translate-x-full')) {
        closeMenu();
      }
    });

    // Close when clicking a link (for smooth navigation)
    sidebar.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        closeMenu();
      });
    });
  }

  // Initialize on page load
  initMobileSidebar();

  // Re-initialize on Astro page transitions (if using View Transitions)
  document.addEventListener('astro:page-load', initMobileSidebar);
</script>
